<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
  <head th:replace="_fragments/layout :: head('회원 관리 - CLD4 Archive')">
    <title>회원 관리 - CLD4 Archive</title>
  </head>
  <body class="d-flex flex-column min-vh-100">
    <div th:replace="_fragments/layout :: header"></div>

    <main class="container mt-4 flex-grow-1">
      <div class="row">
        <div class="col-12">
          <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="h2">
              <i class="bi bi-people text-primary"></i> 회원 관리
            </h1>
            <div>
            </div>
          </div>

          <!-- Enhanced Search Section -->
          <div class="card mb-4">
            <div class="card-header">
              <h5 class="mb-0">
                <i class="bi bi-search me-2"></i>회원 검색
              </h5>
            </div>
            <div class="card-body">
              <form th:action="@{/users}" method="get">
                <input type="hidden" name="status" th:value="${activeStatus}" />
                <input type="hidden" name="sort" th:value="${sort}" />
                <input type="hidden" name="order" th:value="${order}" />
                <div class="row g-3">
                  <div class="col-md-6">
                    <label for="searchQuery" class="form-label">이름/이메일 검색</label>
                    <input
                      type="text"
                      class="form-control"
                      id="searchQuery"
                      name="q"
                      th:value="${q}"
                      placeholder="회원 이름 또는 이메일 입력..."
                    />
                  </div>
                  <div class="col-md-4">
                    <label class="form-label">&nbsp;</label>
                    <div class="d-grid">
                      <button type="submit" class="btn btn-primary">
                        <i class="bi bi-search me-1"></i>검색
                      </button>
                    </div>
                  </div>
                </div>
                <div class="row mt-2" th:if="${not #strings.isEmpty(q)}">
                  <div class="col-12">
                    <a th:href="@{/users(status=${activeStatus}, sort=${sort}, order=${order})}" class="btn btn-outline-secondary btn-sm">
                      <i class="bi bi-x-circle me-1"></i>검색 초기화
                    </a>
                  </div>
                </div>
              </form>
            </div>
          </div>
          <ul class="nav nav-tabs mb-4">
            <li class="nav-item">
              <a
                class="nav-link"
                th:classappend="${activeStatus == 'all'} ? ' active'"
                th:href="@{/users(q=${q}, sort=${sort}, order=${order})}"
              >
                전체
                <span class="badge bg-secondary ms-1" th:text="${countAll}"
                  >0</span
                >
              </a>
            </li>
            <li class="nav-item">
              <a
                class="nav-link"
                th:classappend="${activeStatus == 'approved'} ? ' active'"
                th:href="@{/users(status='approved', q=${q}, sort=${sort}, order=${order})}"
              >
                승인
                <span class="badge bg-secondary ms-1" th:text="${countApproved}"
                  >0</span
                >
              </a>
            </li>
            <li class="nav-item">
              <a
                class="nav-link"
                th:classappend="${activeStatus == 'pending'} ? ' active'"
                th:href="@{/users(status='pending', q=${q}, sort=${sort}, order=${order})}"
              >
                대기
                <span class="badge bg-secondary ms-1" th:text="${countPending}"
                  >0</span
                >
              </a>
            </li>
          </ul>

          <!-- Search Results Info -->
          <div class="d-flex justify-content-between align-items-center mb-3" th:unless="${users.empty}">
            <div class="text-muted">
              <span th:if="${not #strings.isEmpty(q)}">
                검색 결과: <strong th:text="${#lists.size(users)}">0</strong>명의 회원
              </span>
              <span th:unless="${not #strings.isEmpty(q)}">
                전체 <strong th:text="${#lists.size(users)}">0</strong>명의 회원
              </span>
            </div>
          </div>

          <div th:if="${users.empty}" class="text-center py-5">
            <div class="mb-3">
              <i class="bi bi-people" style="font-size: 3rem; color: #6c757d;"></i>
            </div>
            <h5 class="text-muted mb-2">
              <span th:if="${not #strings.isEmpty(q)}">검색 결과가 없습니다</span>
              <span th:unless="${not #strings.isEmpty(q)}">등록된 회원이 없습니다</span>
            </h5>
            <p class="text-muted mb-3">
              <span th:if="${not #strings.isEmpty(q)}">다른 검색 조건을 시도해보세요.</span>
              <span th:unless="${not #strings.isEmpty(q)}">첫 번째 회원을 등록해보세요!</span>
            </p>
            <div th:if="${not #strings.isEmpty(q)}">
              <a th:href="@{/users}" class="btn btn-outline-primary">
                <i class="bi bi-arrow-left me-1"></i>전체 회원 보기
              </a>
            </div>
          </div>

          <div th:unless="${users.empty}" class="card">
            <div class="card-body p-0">
              <div class="table-responsive">
                <table class="table table-hover mb-0 align-middle">
                  <thead>
                    <tr>
                      <th scope="col">#</th>
                      <th scope="col">이름</th>
                      <th scope="col">이메일</th>
                      <th scope="col">역할</th>
                      <th scope="col">승인</th>
                      <th scope="col">
                        가입일
                        <a
                          th:href="@{/users(status=${activeStatus}, q=${q}, sort='createdAt', order=${order=='asc'?'desc':'asc'})}"
                          class="ms-1 text-decoration-none"
                        >
                          <i
                            class="bi"
                            th:classappend="${sort=='createdAt' and order=='asc'} ? ' bi-caret-up-fill' : ' bi-caret-down-fill'"
                          ></i>
                        </a>
                      </th>
                      <th scope="col" class="text-center">관리</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr
                      th:each="user : ${users}"
                      th:classappend="${user.role.name() != 'ADMIN' and !user.approved} ? ' row-pending'"
                    >
                      <td>
                        <a
                          th:href="@{'/users/detail/' + ${user.id}}"
                          class="text-decoration-none"
                        >
                          <strong th:text="${user.id}">#1</strong>
                        </a>
                      </td>
                      <td>
                        <div class="d-flex align-items-center">
                          <i class="bi bi-person-circle me-2 text-muted"></i>
                          <span th:text="${user.name}">이름</span>
                        </div>
                      </td>
                      <td>
                        <div class="d-flex align-items-center">
                          <i class="bi bi-envelope me-2 text-muted"></i>
                          <span th:text="${user.email}">이메일</span>
                        </div>
                      </td>
                      <td>
                        <span th:switch="${user.role.name()}" class="badge">
                          <span th:case="'ADMIN'" class="badge badge-outline"
                            >👑 관리자</span
                          >
                          <span th:case="'TEACHER'" class="badge badge-outline"
                            >👨‍🏫 강사</span
                          >
                          <span th:case="'STUDENT'" class="badge badge-outline"
                            >👨‍🎓 훈련생</span
                          >
                          <span
                            th:case="*"
                            class="badge badge-outline"
                            th:text="${user.role}"
                            >역할</span
                          >
                        </span>
                      </td>
                      <td>
                        <span
                          th:if="${user.role.name() == 'ADMIN'}"
                          class="badge badge-outline"
                          >-</span
                        >
                        <span th:if="${user.role.name() != 'ADMIN'}">
                          <span
                            th:if="${user.approved}"
                            class="badge badge-outline-primary"
                            >승인</span
                          >
                          <span
                            th:unless="${user.approved}"
                            class="badge badge-outline"
                            >대기</span
                          >
                        </span>
                      </td>
                      <td>
                        <small class="text-muted">
                          <i class="bi bi-calendar3"></i>
                          <span
                            th:text="${#temporals.format(user.createdAt, 'yyyy-MM-dd HH:mm')}"
                            >가입일</span
                          >
                        </small>
                      </td>
                      <td class="text-center">
                        <div class="btn-group" role="group">
                          <a
                            th:href="@{/users/{id}(id=${user.id})}"
                            class="btn btn-sm btn-outline-primary"
                            title="상세보기"
                          >
                            <i class="bi bi-eye"></i>
                          </a>
                          <a
                            th:href="@{'/users/edit/' + ${user.id}}"
                            class="btn btn-sm btn-outline-primary"
                            title="수정"
                          >
                            <i class="bi bi-pencil"></i>
                          </a>
                          <form
                            th:action="@{'/users/approve/' + ${user.id}}"
                            method="post"
                            th:if="${user.role.name() != 'ADMIN' and !user.approved}"
                          >
                            <button
                              type="submit"
                              class="btn btn-sm btn-primary"
                              title="승인"
                            >
                              <i class="bi bi-check2-circle"></i>
                            </button>
                          </form>
                          <a
                            th:href="@{'/users/delete/' + ${user.id}}"
                            class="btn btn-sm btn-outline-primary"
                            title="삭제"
                            onclick="return confirm('정말 삭제하시겠습니까?');"
                          >
                            <i class="bi bi-trash"></i>
                          </a>
                        </div>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>

    <div th:replace="_fragments/layout :: footer"></div>
    <div th:replace="_fragments/layout :: scripts"></div>
  </body>
</html>
